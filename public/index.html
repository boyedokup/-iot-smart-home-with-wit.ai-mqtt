<!DOCTYPE html>
 <html>
  <head>
  	<meta charset="utf-8">
    <link rel="stylesheet" href="microphone/css/microphone.min.css">
    <title>IOT-Wit.ai</title>
  </head>
  <body style="text-align: center;">
    <center><div id="microphone"></div></center>
    <pre id="result"></pre>
    <div id="info"></div>
    <div id="error"></div>

    <hr></hr>

   <div id="device_info"></div>
    
    <script src="microphone/js/microphone.min.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <script>
      var device_info = function (msg) {
        document.getElementById("device_info").innerHTML = msg;
      };

      device_info("Connection devices...please wait")

      // Create a client instance: Broker, Port, Websocket Path, Client ID
      client = new Paho.MQTT.Client("broker.hivemq.com", Number(8000), "/mqtt", "1234");



      // set callback handlers
      client.onConnectionLost = function (responseObject) {
      console.log("Connection Lost: "+responseObject.errorMessage);
      }

      client.onMessageArrived = function (message) {
      console.log("Message Arrived: "+message.payloadString);
      dashboard_display(message.payloadString)
      }

      // Called when the connection is made
      function onConnect(){
      console.log("Connected");
      device_info("Devices are connected")
       client.subscribe("/smart-home/device");

      }

      function publish(intent,entities)
      {

        var message = new Paho.MQTT.Message(JSON.stringify(entities));

        message.destinationName ="/smart-home/device";
        message.qos = 1;
        client.send(message);

      }


      function dashboard_display(payload){
        console.log("update UI",payload)
      }

    // Connect the client, providing an onConnect callback
    client.connect({
      onSuccess: onConnect
    });


      var mic = new Wit.Microphone(document.getElementById("microphone"));
      var info = function (msg) {
        document.getElementById("info").innerHTML = msg;
      };
      var error = function (msg) {
        document.getElementById("error").innerHTML = msg;
      };
      mic.onready = function () {
        info("Microphone is ready to record..click on mic");
      };
      mic.onaudiostart = function () {
        info("Recording started... speak command... click mic when done");
        error("");
      };
      mic.onaudioend = function () {
        info("Recording stopped, processing started");
      };
      mic.onresult = function (intent, entities) {
        var r = kv("intent", intent);

        for (var k in entities) {
          var e = entities[k];

          if (!(e instanceof Array)) {
            r += kv(k, e.value);
          } else {
            for (var i = 0; i < e.length; i++) {
              r += kv(k, e[i].value);
            }
          }
        }

        document.getElementById("result").innerHTML = r;
        publish(intent,entities);
      };
      mic.onerror = function (err) {
        error("Error: " + err);
      };
      mic.onconnecting = function () {
        info("Microphone is connecting");
      };
      mic.ondisconnected = function () {
        info("Microphone is not connected");
      };

      mic.connect("XP2ESNAVYVYXEF5YKDJXR4QHWVT7LANY");
      // mic.start();
      // mic.stop();

      function kv (k, v) {
        if (toString.call(v) !== "[object String]") {
          v = JSON.stringify(v);
        }
        return k + "=" + v + "\n";
      }



 
    </script>
  </body>
  </html>